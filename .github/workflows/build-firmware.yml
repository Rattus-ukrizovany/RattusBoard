name: Build RattusBoard Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering from the Actions tab
permissions:
  contents: write
jobs:
  build-firmware:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install QMK CLI
      run: |
        pip3 install qmk
        qmk --version

    - name: Set up QMK environment
      run: |
        qmk setup --yes --home ~/.local/share/qmk

    - name: Copy RattusBoard keyboard files
      run: |
        mkdir -p ~/.local/share/qmk/keyboards/
        cp -r keyboards/rattusboard ~/.local/share/qmk/keyboards/
        ls -la ~/.local/share/qmk/keyboards/rattusboard/
        echo "âœ… RattusBoard keyboard files copied successfully"
        qmk list-keyboards | grep rattusboard || echo "Warning: rattusboard not found in keyboard list"

    - name: Compile firmware
      run: |
        echo "=== Compiling RattusBoard firmware ==="
        echo "QMK Version: $(qmk --version)"
        echo "Available keyboards containing 'rattus':"
        qmk list-keyboards | grep -i rattus || echo "No rattusboard variants found in keyboard list"
        echo ""
        echo "Keyboard files in ~/.local/share/qmk/keyboards/rattusboard/:"
        ls -la ~/.local/share/qmk/keyboards/rattusboard/
        echo ""
        
        # Compile the firmware (both default and VIAL)
        echo "=== Compiling default firmware ==="
        if qmk compile -kb rattusboard -km default; then
          echo "âœ… Default firmware compilation successful!"
        else
          echo "âŒ Default firmware compilation failed"
          exit 1
        fi
        
        echo "=== Compiling VIAL firmware ==="
        if qmk compile -kb rattusboard -km vial; then
          echo "âœ… VIAL firmware compilation successful!"
        else
          echo "âŒ VIAL firmware compilation failed"
          exit 1
        fi
        
        echo "Searching for generated .uf2 files..."
        find ~/.local/share/qmk -name "*.uf2" -type f -exec ls -la {} \;

    - name: Find and copy all UF2 firmware files
      run: |
        echo "=== Searching for all compiled .uf2 firmware files ==="
        mkdir -p firmware-output
        
        # Search for .uf2 files and log what we find
        echo "Searching in QMK directory for .uf2 files..."
        UF2_FILES=$(find ~/.local/share/qmk -name "*.uf2" -type f 2>/dev/null || true)
        
        if [ -n "$UF2_FILES" ]; then
          echo "Found .uf2 files:"
          echo "$UF2_FILES"
          echo "Copying all .uf2 files to firmware-output/"
          find ~/.local/share/qmk -name "*.uf2" -type f -exec cp {} firmware-output/ \;
        else
          echo "No .uf2 files found in QMK directory"
        fi
        
        # Also check if the build created any .uf2 files in the current directory
        CURRENT_UF2=$(find . -maxdepth 2 -name "*.uf2" -type f 2>/dev/null || true)
        if [ -n "$CURRENT_UF2" ]; then
          echo "Found additional .uf2 files in current directory:"
          echo "$CURRENT_UF2"
          find . -maxdepth 2 -name "*.uf2" -type f -exec cp {} firmware-output/ \;
        fi
        
        echo "=== Final firmware-output directory contents ==="
        ls -la firmware-output/
        
        # Count and log what we have
        UF2_COUNT=$(find firmware-output/ -name "*.uf2" -type f | wc -l)
        echo "Total .uf2 files collected: $UF2_COUNT"
        
        if [ "$UF2_COUNT" -gt 0 ]; then
          echo "Successfully collected firmware files:"
          find firmware-output/ -name "*.uf2" -type f
        else
          echo "WARNING: No .uf2 firmware files were collected"
        fi

    - name: Upload firmware artifacts (all .uf2 files)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: rattusboard-firmware
        path: firmware-output/*
        if-no-files-found: warn
        retention-days: 30

    - name: Artifact upload summary
      if: always()
      run: |
        echo "=== Artifact Upload Summary ==="
        if [ -d firmware-output/ ]; then
          FILE_COUNT=$(find firmware-output/ -type f | wc -l)
          UF2_COUNT=$(find firmware-output/ -name "*.uf2" -type f | wc -l)
          echo "ðŸ“ Total files in firmware-output/: $FILE_COUNT"
          echo "ðŸ”§ UF2 firmware files: $UF2_COUNT"
          
          if [ "$UF2_COUNT" -gt 0 ]; then
            echo "âœ… Firmware files ready for release:"
            find firmware-output/ -name "*.uf2" -type f -exec basename {} \;
          else
            echo "âš ï¸  No .uf2 files available for release"
          fi
        else
          echo "âŒ No firmware-output directory found"
        fi

  release-firmware:
    needs: build-firmware
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download firmware artifact
      uses: actions/download-artifact@v4
      with:
        name: rattusboard-firmware
        path: firmware-artifacts/

    - name: Comprehensive firmware diagnostics
      run: |
        echo "=== Comprehensive Firmware Diagnostics ==="
        echo "Current working directory: $(pwd)"
        echo "Directory contents:"
        ls -la .
        
        echo ""
        echo "=== firmware-artifacts/ directory analysis ==="
        if [ -d firmware-artifacts/ ]; then
          echo "firmware-artifacts/ exists. Contents:"
          find firmware-artifacts/ -type f -exec ls -la {} \;
          echo ""
          echo "All files in firmware-artifacts/:"
          find firmware-artifacts/ -type f
          echo ""
          echo "UF2 files in firmware-artifacts/:"
          find firmware-artifacts/ -name "*.uf2" -type f || echo "No .uf2 files found"
        else
          echo "firmware-artifacts/ directory does not exist"
        fi
        
        echo ""
        echo "=== File type analysis ==="
        find firmware-artifacts/ -type f -exec file {} \; 2>/dev/null || echo "No files to analyze"

    - name: Check for any UF2 firmware files
      id: check_firmware
      run: |
        echo "=== Checking for UF2 firmware files ==="
        
        # Find all .uf2 files in firmware-artifacts/
        UF2_FILES=$(find firmware-artifacts/ -name "*.uf2" -type f 2>/dev/null || true)
        UF2_COUNT=$(echo "$UF2_FILES" | grep -c . 2>/dev/null || echo "0")
        
        echo "Found $UF2_COUNT .uf2 files"
        
        if [ -n "$UF2_FILES" ] && [ "$UF2_COUNT" -gt 0 ]; then
          echo "firmware_found=true" >> $GITHUB_OUTPUT
          echo "uf2_count=$UF2_COUNT" >> $GITHUB_OUTPUT
          
          # Create a properly formatted file list for release assets
          echo "uf2_files<<EOF" >> $GITHUB_OUTPUT
          echo "$UF2_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… SUCCESS: Firmware files found and ready for release:"
          echo "$UF2_FILES" | while read -r file; do
            if [ -n "$file" ]; then
              echo "  - $(basename "$file") ($(ls -lh "$file" | awk '{print $5}'))"
            fi
          done
        else
          echo "firmware_found=false" >> $GITHUB_OUTPUT
          echo "uf2_count=0" >> $GITHUB_OUTPUT
          echo "âŒ No UF2 firmware files found."
          echo ""
          echo "=== Debugging information ==="
          echo "Searched in: firmware-artifacts/"
          echo "All files found:"
          find firmware-artifacts/ -type f 2>/dev/null || echo "No files found"
          echo ""
          echo "Reasons a release might be skipped:"
          echo "1. Firmware compilation failed in the build job"
          echo "2. QMK configuration issues prevented .uf2 generation"
          echo "3. File permissions or path issues during artifact upload/download"
          echo "4. The firmware was built but not saved to the expected output directory"
        fi

    - name: Create Release and Upload All Firmware Files
      if: steps.check_firmware.outputs.firmware_found == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "build-${{ github.sha }}"
        name: "RattusBoard Firmware Build ${{ github.sha }}"
        body: |
          ## RattusBoard Firmware Release

          Automatically generated firmware build from commit [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }}).

          **ðŸ“¦ This release contains ${{ steps.check_firmware.outputs.uf2_count }} firmware file(s)**

          ### Installation Instructions
          1. Download the appropriate `.uf2` file(s) from the assets below.
          2. Hold BOOTSEL and plug in USB on each Pico to enter bootloader mode.
          3. Drag the `.uf2` onto the RPI-RP2 drive for both halves.
          4. Connect halves with TRRS cable and plug USB into the left half.

          ### Available Firmware Files
          This release includes all compiled firmware variants. For typical users, download `rattusboard_default.uf2` if available.

          ### Features
          - Split keyboard support with auto hand detection
          - PMW3360 trackball integration (right half)
          - Rotary encoder support (right half)
          - VIA/Vial configuration support
          - Full QMK feature set

          For detailed setup instructions, see the [README](https://github.com/${{ github.repository }}#-firmware-flashing--split-setup-important-clarification).
        files: firmware-artifacts/*.uf2
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Log successful release
      if: steps.check_firmware.outputs.firmware_found == 'true'
      run: |
        echo "âœ… SUCCESS: Release created successfully!"
        echo "ðŸ“¦ Release tag: build-${{ github.sha }}"
        echo "ðŸ“ Files attached: ${{ steps.check_firmware.outputs.uf2_count }} firmware file(s)"
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/build-${{ github.sha }}"

    - name: Log release skipped with detailed diagnostics
      if: steps.check_firmware.outputs.firmware_found != 'true'
      run: |
        echo "âŒ RELEASE SKIPPED: No firmware files available for release"
        echo ""
        echo "=== Detailed Diagnostics ==="
        echo "ðŸ” Trigger event: ${{ github.event_name }}"
        echo "ðŸŒ¿ Branch/ref: ${{ github.ref }}"
        echo "ðŸ’¾ Commit SHA: ${{ github.sha }}"
        echo ""
        echo "=== Troubleshooting Steps ==="
        echo "1. Check the build-firmware job logs for compilation errors"
        echo "2. Verify QMK configuration in keyboards/rattusboard/"
        echo "3. Ensure the keyboard configuration is valid and can compile"
        echo "4. Check if the firmware files were generated but not uploaded correctly"
        echo ""
        echo "=== Current Artifact Contents ==="
        echo "Files found in firmware-artifacts/:"
        find firmware-artifacts/ -type f -exec ls -la {} \; 2>/dev/null || echo "No files found"
        echo ""
        echo "=== Next Steps ==="
        echo "â€¢ Fix any compilation errors in the build job"
        echo "â€¢ Ensure QMK setup is correct for the rattusboard keyboard"
        echo "â€¢ Verify that .uf2 files are being generated and copied to firmware-output/"
        echo "â€¢ Check that the artifact upload/download process is working correctly"
